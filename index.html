<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuCliniCard - Sistema Médico Familiar Completo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS Styles (sin cambios) */
    </style>
</head>
<body>
    <!-- Contenido de la página -->

    <script>
        // ========================================= 
        //           SUPABASE CONFIGURATION           
        // ========================================= 
        const SUPABASE_URL = 'https://ooacvnvxuvnhwodpqwoh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vYWN2bnZ4dXZuaHdvZHBxd29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODQ2MDcsImV4cCI6MjA3MTE2MDYwN30.8GXjZfvKlPV-0v3vXglZsvke2U4gGgl4YVtwgfRNNVw';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========================================= 
        //              GLOBAL STATE                 
        // ========================================= 
        let currentUser = null;
        let userType = null;

        // ========================================= 
        //            INITIALIZATION                 
        // ========================================= 
        document.addEventListener('DOMContentLoaded', function() {
            showLandingPage();
            loadDoctors();
            
            // Set minimum date for appointments to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointment-date').setAttribute('min', today);
            
            // Check for existing session
            checkAuthSession();
        });

        // ========================================= 
        //             UTILITY FUNCTIONS             
        // ========================================= 
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // ========================================= 
        //            NAVIGATION FUNCTIONS           
        // ========================================= 
        function showLandingPage() {
            document.getElementById('landing-page').style.display = 'block';
            document.getElementById('patient-dashboard').classList.remove('active');
            document.getElementById('doctor-dashboard').classList.remove('active');
            document.getElementById('landing-footer').style.display = 'block';
            updateNavButtons();
        }

        function showPatientDashboard() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('patient-dashboard').classList.add('active');
            document.getElementById('doctor-dashboard').classList.remove('active');
            document.getElementById('landing-footer').style.display = 'none';
            updateNavButtons();
            loadPatientData();
        }

        function showDoctorDashboard() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('patient-dashboard').classList.remove('active');
            document.getElementById('doctor-dashboard').classList.add('active');
            document.getElementById('landing-footer').style.display = 'none';
            updateNavButtons();
            loadDoctorData();
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function updateNavButtons() {
            const navButtons = document.getElementById('nav-buttons');
            if (currentUser) {
                navButtons.innerHTML = `
                    <span style="color: var(--primary-blue); font-weight: 600;">
                        <i class="fas fa-user"></i> ${currentUser.name}
                    </span>
                    <button class="btn btn-outline" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                `;
            } else {
                navButtons.innerHTML = `
                    <button class="btn btn-outline" onclick="openModal('patient-login')">
                        <i class="fas fa-user"></i> Pacientes
                    </button>
                    <button class="btn btn-primary" onclick="openModal('doctor-login')">
                        <i class="fas fa-user-md"></i> Médicos
                    </button>
                `;
            }
        }

        // ========================================= 
        //             MODAL FUNCTIONS               
        // ========================================= 
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'appointment') {
                loadDoctors();
            } else if (modalId === 'new-record') {
                loadPatientsForRecord();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('record-date').value = today;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function switchModal(fromModal, toModal) {
            closeModal(fromModal);
            openModal(toModal);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // ========================================= 
        //           AUTHENTICATION FUNCTIONS        
        // ========================================= 
        async function checkAuthSession() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;
                
                if (session) {
                    console.log('Session found, loading user profile...');
                    await loadUserFromSession(session.user);
                }
            } catch (error) {
                console.error('Error checking session:', error);
            }
        }

        async function loadUserFromSession(authUser) {
            try {
                // Try loading as patient
                const { data: patient, error: patientError } = await supabase
                    .from('patients')
                    .select('*')
                    .eq('email', authUser.email)
                    .eq('status', 'active')
                    .single();

                if (patient) {
                    currentUser = patient;
                    userType = 'patient';
                    showPatientDashboard();
                    return;
                }

                // Try loading as doctor
                const { data: doctor, error: doctorError } = await supabase
                    .from('doctors')
                    .select('*')
                    .eq('email', authUser.email)
                    .eq('status', 'active')
                    .single();

                if (doctor) {
                    currentUser = doctor;
                    userType = 'doctor';
                    showDoctorDashboard();
                    return;
                }

                console.log('User authenticated but no profile found');
                
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        async function loginPatient(event) {
            event.preventDefault();
            showLoading();
            
            const formData = new FormData(event.target);
            const email = formData.get('email');
            const password = formData.get('password');
            
            try {
                console.log('Attempting patient login with:', email);
                
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) {
                    console.error('Auth error:', authError);
                    if (authError.message.includes('Invalid login credentials')) {
                        throw new Error('Email o contraseña incorrectos. Verifica tus credenciales.');
                    }
                    throw authError;
                }
                
                console.log('Auth successful, searching for patient profile...');
                
                const { data: patient, error: patientError } = await supabase
                    .from('patients')
                    .select('*')
                    .eq('email', email)
                    .eq('status', 'active')
                    .single();
                
                if (patientError || !patient) {
                    console.error('Patient profile error:', patientError);
                    await supabase.auth.signOut();
                    throw new Error('Este email no está registrado como paciente.');
                }
                
                console.log('Patient found:', patient);
                
                currentUser = patient;
                userType = 'patient';
                
                closeModal('patient-login');
                showPatientDashboard();
                showNotification(`¡Bienvenido ${patient.name}!`, 'success');
                event.target.reset();
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification(error.message || 'Error al iniciar sesión', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loginDoctor(event) {
            event.preventDefault();
            showLoading();
            
            const formData = new FormData(event.target);
            const email = formData.get('email');
            const password = formData.get('password');
            
            try {
                console.log('Attempting doctor login with:', email);
                
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) {
                    console.error('Doctor auth error:', authError);
                    if (authError.message.includes('Invalid login credentials')) {
                        throw new Error('Email o contraseña incorrectos. Verifica tus credenciales institucionales.');
                    }
                    throw authError;
                }
                
                console.log('Doctor auth successful, searching for doctor profile...');
                
                const { data: doctor, error: doctorError } = await supabase
                    .from('doctors')
                    .select('*')
                    .eq('email', email)
                    .eq('status', 'active')
                    .single();
                
                if (doctorError || !doctor) {
                    console.error('Doctor profile error:', doctorError);
                    await supabase.auth.signOut();
                    throw new Error('Este email no está registrado como médico en el sistema.');
                }
                
                console.log('Doctor found:', doctor);
                
                currentUser = doctor;
                userType = 'doctor';
                
                closeModal('doctor-login');
                showDoctorDashboard();
                showNotification(`Bienvenida al sistema, ${doctor.name}`, 'success');
                event.target.reset();
                
            } catch (error) {
                console.error('Doctor login error:', error);
                showNotification(error.message || 'Error al iniciar sesión', 'error');
            } finally {
                hideLoading();
            }
        }

        async function registerPatient(event) {
            event.preventDefault();
            showLoading();
            
            const formData = new FormData(event.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const name = formData.get('name');
            const phone = formData.get('phone');
            
            try {
                // Create user in Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name,
                            phone: phone,
                            user_type: 'patient'
                        }
                    }
                });
                
                if (authError) {
                    if (authError.message.includes('already registered')) {
                        throw new Error('Este email ya está registrado. Intenta iniciar sesión.');
                    }
                    throw authError;
                }
                
                // Create patient profile
                const patientData = {
                    email: email,
                    name: name,
                    phone: phone,
                    date_of_birth: formData.get('date_of_birth') || null,
                    gender: formData.get('gender') || null,
                    status: 'active'
                };
                
                const { data: patient, error: patientError } = await supabase
                    .from('patients')
                    .insert([patientData])
                    .select()
                    .single();
                
                if (patientError) {
                    console.error('Patient creation error:', patientError);
                    throw patientError;
                }
                
                closeModal('patient-register');
                showNotification('¡Cuenta creada exitosamente! Revisa tu email para confirmar.', 'success');
                event.target.reset();
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification(error.message || 'Error al crear cuenta', 'error');
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                userType = null;
                
                showLandingPage();
                showNotification('Has cerrado sesión correctamente', 'success');
                
            } catch (error) {
                console.error('Logout error:', error);
                currentUser = null;
                userType = null;
                showLandingPage();
                showNotification('Sesión cerrada', 'info');
            }
        }

    </script>
</body>
</html>
